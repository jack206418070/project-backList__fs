<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>一般頁面</title>
  <link rel="stylesheet" href="./css/all.css" class="css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" class="css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" class="css">
</head>

<body oncontextmenu="return false;" oncut="return false">
  <div id="app">
    <input id="copyWarnId" type="text" value="不要亂複製截圖" style="position: fixed; top:0; opacity: 0;">
    <div v-if="isLoading" class="loading"></div>
    <a href="javascript:;" class="scrollTop" @click.prevent="upToTop">
      <i class="fa-solid fa-arrow-up"></i>
    </a>
    <div v-if="checkIp == true">
      <div class="header">
        <div class="container-lg d-flex jy-content-between align-items-center">
          <div class="logo">
            <img
              src="https://static.wixstatic.com/media/a30359_51ace8f8de8143019b8d6b64011f9216~mv2.png/v1/fill/w_412,h_194,al_c,q_85,usm_0.66_1.00_0.01/%E6%96%B0logo-removebg-preview.webp"
              alt="" style="height: 100px">
          </div>
          <div class="menu">
            <ul class="d-flex">
              <li class="d-flex align-items-center" style="position: relative;">
                <input type="text" style="width: 200px; padding: 10px 5px 10px 10px;" v-model.trim="searchText">
                <a href="javascript:;" class="list-control" style="position: absolute; right: -10px" @click="getOrderList(0)">
                  <i class="fa-solid fa-magnifying-glass"></i>
                </a>
              </li>
              <li>
                <a class="list-control" href="./normal.html">一般頁面</a>
              </li>
              <li>
                <a class="list-control" href="./list.html">增量頁面</a>
              </li>
              <li>
                <a class="list-control" href="./na.html">N/A頁面</a>
              </li>
              <li>
                <a class="list-control" href="./operate.html">經營頁面</a>
              </li>
              <li v-if="displayName === '管理'">
                <a class="account-control" href="./admin.html">帳號管理</a>
              </li>
              <li>
                <a class="list-control" @click.prevent="logout">登出</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container-lg">
        <div class="list">
          <div class="list-title">一般頁面</div>
          <div v-if="show_page" class="pagnation" style="position: sticky; top: 0px; background: #F8F9F0; padding: 15px 0; z-index: 99">
            <ul class="d-flex jy-content-center">
                <li>
                    <a href="#" @click.prevent="getOrderList(currentPage - 1)">上一頁</a>
                </li>
                <template v-for="page in allPage" :key="page">
                    <li>
                        <a href="#" :class="{'active': (currentPage + 1) == page}" @click.prevent="getOrderList(page - 1)">{{ page }}</a>
                    </li>
                </template>
                <li>
                    <a href="#" @click.prevent="getOrderList(currentPage - 1)">下一頁</a>
                </li>
            </ul>
        </div>
        <div v-if="normal_search_count !== null">
          <p style="font-size: 24px; font-weight: bold; padding-left: 16px; color: red;">一般頁面: {{ normal_search_count }}</p>
        </div>
        <div v-if="order_search_count !== null">
          <p style="font-size: 24px; font-weight: bold; padding-left: 16px; color: red;">增量頁面: {{ order_search_count }}</p>
        </div>
        <div v-if="na_search_count !== null">
          <p style="font-size: 24px; font-weight: bold; padding-left: 16px; color: red;">NA頁面: {{ na_search_count }}</p>
        </div>
        <div v-if="operate_search_count !== null">
          <p style="font-size: 24px; font-weight: bold; padding-left: 16px; color: red;">經營頁面: {{ operate_search_count }}</p>
        </div>
        <div v-if="search_count !== null">
          <p style="font-size: 24px; font-weight: bold; padding-left: 16px; color: red;">搜尋數量: {{ search_count }}</p>
        </div>
          <div class="add__list" style="position: sticky; top: 70px; background: #F8F9F0; padding: 15px 0; z-index: 99">
            <a class="add" href="#"
              @click.prevent="openAddOrder">新增訂單</a>
            <a class="add" href="#" @click.prevent="openBefore">前貸管理</a>
            <a class="add" href="#" @click.prevent="openNumber">總期數管理</a>
            <div class="search">
              <select
                name="before"
                id="before"
                v-model="search.before"
              >
                <option value="不管有無貸款">不管有無貸款</option>
                <option value="有前貸">有前貸</option>
                <option value="無前貸">無前貸</option>
              </select>
              <select
                name="mname"
                id="mname"
                v-model="search.mname"
                v-if="displayName === '管理'"
              >
                <option value="所有業務">所有業務</option>
                <option v-for="mname in mnameData" :value="mname">{{ mname }}</option>
              </select>
              <select
                name="type"
                id="type"
                v-model="search.type"
              >
                <option value="">所有車種</option>
                <option value="機">機車</option>
                <option value="汽">汽車</option>
              </select>
              <select
                name="search"
                id="search"
                v-model="search.staging"
              >
                <option value="所有期數">所有期數</option>
                <option value="期數大於" selected>期數大於</option>
                <option value="期數小於">期數小於</option>
                <option value="期數等於">期數等於</option>
                <option value="期數大於等於">期數大於等於</option>
                <option value="期數小於等於">期數小於等於</option>
              </select>
              <input type="text" v-model="search.search_text">
              <a v-if="displayName === '管理'" class="search-btn" href="#" @click.prevent="searchBtn(search.search_text)">搜尋</a>
              <a v-else class="search-btn" href="#" @click.prevent="staffsearchBtn(search.search_text)">搜尋</a>
            </div>

          </div>

          <ul class="no-print">
            <li style="position: sticky; top: 130px; background: #F8F9F0; z-index: 99">
              <div class="date">日期
                <i v-if="modalControl.is_order_dec == 0 && modalControl.is_page == 0" class="fa-solid fa-angles-down"
                  @click="modalControl.is_order_dec = 1; filterData = 1"></i>
                <i v-else-if="modalControl.is_order_dec == 1 && modalControl.is_page == 0" class="fa-solid fa-angles-up"
                  @click="modalControl.is_order_dec = 0;  filterData = 0"></i>
              </div>
              <div class="name">姓名</div>
              <div class="carId">車牌</div>
              <div class="phone">電話</div>
              <div class="lineId">LINE</div>
              <div class="type">
                <p>汽</p>
                <p>機</p>
              </div>
              <div class="before">前貸</div>
              <div class="money">貸款金額</div>
              <div class="staging">期數</div>
              <div class="month">月付款</div>
              <div class="dieLine">應繳日</div>
              <div class="extra">備註</div>
              <div class="inDate">進件日期</div>
              <div class="reason">不良原因</div>
              <div class="btn-control">操作</div>
            </li>
            <list v-for="item in orderList" :key="item.id" :item="item" :uid="uid" :display-name="displayName"
              @delete-order="deleteOrder" @edit-order="editOrder" 
              @detail-order="detailOrder"
              @trans-list="transList">
            </list>

          </ul>
          <ul class="print-page" v-for="page in printLen">
            <li>
              <div class="date">日期
                <i v-if="modalControl.is_order_dec == 0 && modalControl.is_page == 0" class="fa-solid fa-angles-down"
                  @click="modalControl.is_order_dec = 1; filterData = 1"></i>
                <i v-else-if="modalControl.is_order_dec == 1 && modalControl.is_page == 0" class="fa-solid fa-angles-up"
                  @click="modalControl.is_order_dec = 0;  filterData = 0"></i>
              </div>
              <div class="name">姓名</div>
              <div class="carId">車牌</div>
              <div class="phone">電話</div>
              <div class="lineId">LINE</div>
              <div class="type">
                <p>汽</p>
                <p>機</p>
              </div>
              <div class="before">前貸</div>
              <div class="money">貸款金額</div>
              <div class="staging">期數</div>
              <div class="month">月付款</div>
              <div class="dieLine">應繳日</div>
              <div class="extra">備註</div>
              <div class="inDate">進件日期</div>
              <div class="reason">不良原因</div>
              <div class="btn-control">操作</div>
            </li>
            <list v-for="item in printData[page - 1]" :key="item.id" :item="item" :uid="uid" :display-name="displayName"
              @delete-order="deleteOrder" @edit-order="editOrder">
            </list>
          </ul>
        </div>
        <div v-if="show_page" class="pagnation">
          <ul class="d-flex jy-content-center">
              <li>
                  <a href="#" @click.prevent="getOrderList(currentPage - 1)">上一頁</a>
              </li>
              <template v-for="page in allPage" :key="page">
                  <li>
                      <a href="#" :class="{'active': (currentPage + 1) == page}" @click.prevent="getOrderList(page - 1)">{{ page }}</a>
                  </li>
              </template>
              <li>
                  <a href="#" @click.prevent="getOrderList(currentPage - 1)">下一頁</a>
              </li>
          </ul>
      </div>

        <!-- <div class="pagnation" v-if="modalControl.is_page == 1">
                    <ul class="d-flex jy-content-center">
                        <li>
                            <a href="#" @click.prevent="paginationHandler
                            (currentPage - 1)">上一頁</a>
                        </li>
                        <template v-for="page in pageLists.length" :key="page">
                            <li v-if="pageLists[page - 1].length > 0">
                                <a href="#" :class="{'active': currentPage == page}" @click.prevent="paginationHandler
                                (page)">{{ page }}</a>
                            </li>
                        </template>
                        <li>
                            <a href="#" @click.prevent="paginationHandler
                            (currentPage + 1)">下一頁</a>
                        </li>
                    </ul>
                </div> -->
      </div>

      <div class="add-modal" :class="{'show': modalControl.is_add === true}">
        <div class="title">
          <h2>新增訂單</h2>
        </div>
        <div class="content">
          <form action="#">
            <div class="form-group">
              <div class="form-control">
                <label for="date">日期(必填)</label>
                <input type="date" id="date" v-model="tempOrderList.date">
              </div>
              <div class="form-control">
                <label for="name">姓名(必填)</label>
                <input type="text" id="name" v-model="tempOrderList.name">
              </div>
              <div class="form-control">
                <label for="carId">車牌</label>
                <input type="text" id="carId" @change="checkCarId" v-model="tempOrderList.carId">
              </div>
            </div>
            <div class="form-group" style="align-items: center">
              <div class="form-control">
                <label for="phone">電話(必填)</label>
                <input type="phone" id="phone" v-model="tempOrderList.phone" @blur="checkFormOrder('phone')" style="margin-bottom: 40px">
                <label for="before">前貸</label>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <select name="before" id="before" v-model="tempOrderList.before" style="width: 100%;">
                    <option v-for="item in beforeList" :value="item" :key="item">{{ item }}</option>
                  </select>
                </div>
              </div>
              <div class="form-control">
                <label for="line">LineID</label>
                <input type="text" id="line" v-model="tempOrderList.lineId" style="margin-bottom: 40px">
                <label for="money">貸款金額</label>
                <input type="text" id="money" v-model="tempOrderList.money">
              </div>
              <div class="form-control type">
                <label for="type">分期類別</label>
                汽<input type="radio" value="汽" v-model="tempOrderList.type">
                機<input type="radio" value="機" v-model="tempOrderList.type" style="margin-bottom: 13px;">
                <label for="staging_number">已繳期數(必填)<br>(若無期數填寫 N/A)</label>
                <input type="text" id="staging_number" v-model="tempOrderList.staging_number" style="width: 100%"  placeholder="N/A">
                <label for="staging.allNumber">總期數</label>
                <select v-model="tempOrderList.staging_allNumber" name="staging_allNumber" id="staging_allNumber">
                  <option v-for="item in allNumberList" :value="item">{{item}}期</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <div class="form-control">
                <label for="month">月付款</label>
                <input type="number" id="month" v-model="tempOrderList.month">
              </div>
              <div class="form-control">
                <label for="dieLine">應繳日</label>
                <input type="text" id="dieLine" v-model="tempOrderList.dieLine">
              </div>
              <div class="form-control">
                <label for="latePay">遲繳天數</label>
                <input style="width: 90%" type="text" id="latePay" v-model="tempOrderList.latePay" placeholder="不填寫=無遲繳">
                <span style="padding-left: 4px">天</span>
              </div>
            </div>
            <div class="form-group">
              <div class="form-control">
                <label for="inDate">進件日期</label>
                <input type="date" id="inDate" v-model="tempOrderList.inDate">
              </div>
              <div class="form-control">
                <label for="reason">聯絡日期</label>
                <input type="date" id="inDate" v-model="tempOrderList.connectDate">
              </div>
              <div class="form-control">
                <label for="reason">不良原因</label>
                <input type="text" id="reason" v-model="tempOrderList.reason">
              </div>
            </div>
            <div class="form-control w-100">
              <label for="extra">備註</label>
              <textarea name="extra" id="extra" cols="30" rows="10" v-model="tempOrderList.extra"></textarea>
            </div>
            <div class="btn-group">
              <a class="close" href="#" @click.prevent="closeAddOrder(); tempOrderList = {}">取消</a>
              <a class="add" href="#" @click.prevent="add">增加訂單</a>
            </div>
          </form>
        </div>
      </div>

      <div class="edit-modal" :class="{'show': modalControl.is_edit === true}">
        <div class="title">
          <h2>修改訂單</h2>
        </div>
        <div class="content">
          <form action="#">
            <div class="form-group">
              <div class="form-control">
                <label for="date">日期(必填)</label>
                <input type="date" id="date" v-model="tempOrderList.date">
              </div>
              <div class="form-control">
                <label for="name">姓名(必填)</label>
                <input type="text" id="name" v-model="tempOrderList.name">
              </div>
              <div class="form-control">
                <label for="carId">車牌</label>
                <input type="text" id="carId" v-model="tempOrderList.carId" @change="checkCarId">
              </div>
            </div>
            <div class="form-group" style="align-items: center">
              <div class="form-control">
                <label for="phone">電話(必填)</label>
                <input type="phone" id="phone" v-model="tempOrderList.phone" @blur="checkFormOrder('phone')" style="margin-bottom: 40px">
                <label for="before">前貸</label>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <select name="before" id="before" v-model="tempOrderList.before" style="width: 100%;">
                    <option v-for="item in beforeList" :value="item" :key="item">{{ item }}</option>
                  </select>
                </div>
              </div>
              <div class="form-control">
                <label for="line">LineID</label>
                <input type="text" id="line" v-model="tempOrderList.lineId" style="margin-bottom: 40px">
                <label for="money">貸款金額</label>
                <input type="text" id="money" v-model="tempOrderList.money">
              </div>
              <div class="form-control type">
                <label for="type">分期類別</label>
                汽<input type="radio" v-model="tempOrderList.type" value="汽" :checked="tempOrderList.type === '汽'">
                機<input type="radio" v-model="tempOrderList.type" value="機" :checked="tempOrderList.type === '機'"
                  style="margin-bottom: 13px;">
                <label for="staging_number">已繳期數(必填)<br>(若無期數填寫 N/A)</label>
                <input type="text" id="staging_number" v-model="tempOrderList.staging_number" style="width: 100%">
                <label for="staging.allNumber">總期數</label>
                <select v-model="tempOrderList.staging_allNumber" name="staging_allNumber" id="staging_allNumber">
                  <option v-for="item in allNumberList" :value="item">{{item}}期</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <div class="form-control">
                <label for="month">月付款</label>
                <input type="number" id="month" v-model="tempOrderList.month">
              </div>
              <div class="form-control">
                <label for="dieLine">應繳日</label>
                <input type="text" id="dieLine" v-model="tempOrderList.dieLine">
              </div>
              <div class="form-control">
                <label for="latePay">遲繳天數</label>
                <input style="width: 90%" type="text" id="latePay" v-model="tempOrderList.latePay" placeholder="不填寫=無遲繳">
                <span style="padding-left: 4px">天</span>
              </div>
            </div>
            <div class="form-group">
              <div class="form-control">
                <label for="inDate">進件日期</label>
                <input type="date" id="date" v-model="tempOrderList.inDate">
              </div>
              <div class="form-control">
                <label for="reason">聯絡日期</label>
                <input type="date" id="inDate" v-model="tempOrderList.connectDate">
              </div>
              <div class="form-control">
                <label for="reason">不良原因</label>
                <input type="text" id="money" v-model="tempOrderList.reason">
              </div>
            </div>
            <div class="form-control w-100">
              <label for="extra">備註</label>
              <textarea name="extra" id="extra" cols="30" rows="10" v-model="tempOrderList.extra"></textarea>
            </div>
            <div class="btn-group">
              <a class="close" href="#" @click.prevent="closeEdit">取消</a>
              <a class="add" href="#" @click.prevent="editModal">修改訂單</a>
            </div>
          </form>
        </div>
      </div>

      <div class="delete-modal" :class="{'show': modalControl.is_delete === true}">
        <div class="title">
          <h3>刪除訂單</h3>
        </div>
        <div class="content">
          <p>確定要刪除 <span style="color: red">{{ tempOrderList.name }} 的 {{ tempOrderList.carId }}</span> 訂單嗎 ？</p>
          <div class="btn-group">
            <a class="close" href="#" @click.prevent="delModal(false)">取消</a>
            <a class="delete" href="#" @click.prevent="delModal(true)">確定刪除</a>
          </div>
        </div>
      </div>

      <div class="before-modal" :class="{'show': modalControl.is_before === true}">
        <div class="title">
          <h3>前貸管理</h3>
        </div>
        <div class="content">
          <div class="content-list">
            <div class="before-item" v-for="(item, index) in beforeList" :key="index">
              <p>{{ item }}</p>
              <a href="javascript:;" @click="deleteBefore(item)">刪除</a>
            </div>
          </div>
          <div class="btn-group">
            <input type="text" placeholder="請輸入新增的前貸" v-model.trim="tempBefore">
            <a class="close" style="background: blue" href="#" @click.prevent="add_Before">新增前貸</a>
          </div>
          <div class="btn-group">
            <a class="close" href="#" @click.prevent="closeBefore">取消</a>
          </div>
        </div>
      </div>
      <div class="detail-modal">
        <div class="title">
          事件記錄
        </div>
        <div class="content">
          <textarea name="content" id="content" v-model="detail_content"></textarea>
          <div class="btn-group">
            <a class="close" href="javascript:;" @click="closeDetail">取消</a>
            <a class="save" href="javascript:;" @click="editDetail">儲存</a>
          </div>
        </div>
      </div>
      <div class="allNumber-modal" :class="{'show': modalControl.is_allNumber === true}">
        <div class="title">
          <h3>總期數管理</h3>
        </div>
        <div class="content">
          <div class="content-list">
            <div class="before-item" v-for="(item, index) in allNumberList" :key="index">
              <p>{{ item }}</p>
              <a href="javascript:;" @click="deleteAllNumber(item)">刪除</a>
            </div>
          </div>
          <div class="btn-group">
            <input type="text" placeholder="請輸入新增的總期數" v-model.trim="tempAllNumber">
            <a class="close" style="background: blue" href="#" @click.prevent="add_AllNumber">新增總期數</a>
          </div>
          <div class="btn-group">
            <a class="close" href="#" @click.prevent="closeNumber">取消</a>
          </div>
        </div>
      </div>
    </div>
    <noscript><iframe src=*.html></iframe></noscript>
    <p id="test" style="display: none;">版權所有</p>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.25.0/axios.min.js"></script>
  <script src="https://unpkg.com/vue@3.4.4/dist/vue.global.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script type="text/x-template" id="list">
      <li>
        <div class="date">{{ item.date }} <br><span v-if="item.connectDate != '' && item.connectDate != undefined" style="display: block">( {{ item.connectDate }} )</span> <span>( {{ item.mname }} )</span> <span style="display:block" v-if="item.latePay != '' && item.latePay != undefined">( 遲繳 {{ item.latePay }} 天 )</span> </div>
        <div class="name">{{ item.name }}</div>
        <div class="carId">{{ item.carId }}</div>
        <div class="phone">{{ phoneFormat }}</div>
        <div class="lineId">{{ item.lineId }}</div>
        <div class="type">
            <p>{{ item.type == '汽' ? 'V' : ''}}</p>
            <p>{{ item.type == '機' ? 'V' : ''}}</p>
        </div>
        <div class="before">{{ item.before }}</div>
        <div class="money">{{ item.money }}</div>
        <div class="staging"><div>{{ item.staging_number }} / {{ item.staging_allNumber }}</div><div>{{item.prev_staging_date}}</div></div>
        <div class="month">{{ item.month }}</div>
        <div class="dieLine">{{ item.dieLine }}</div>
        <div class="extra">{{ item.extra }}</div>
        <div class="inDate">{{ item.inDate }}</div>
        <div class="reason">{{ item.reason }}</div>
        <div class="btn-control" v-if="displayName !== '組長' || (displayName === '組長' && item.uId === uid)">
            <a class="edit" href="#" @click.prevent="$emit('editOrder', $event , item)">編輯</a>
            <a class="delete" href="#" @click.prevent="$emit('deleteOrder', item)">刪除</a>
            <div class="transform-group" :class="{ 'show': transShow }">
              <a href="#" class="trans" @click.prevent="$emit('transList', item, 'order'), transShow = false">至 增量</a>
              <a href="#" class="trans" @click.prevent="$emit('transList', item, 'na'), transShow = false">至 N/A</a>
              <a href="#" class="trans" @click.prevent="$emit('transList', item, 'operate'), transShow = false">至 經營</a>
            </div>
            <a class="delete" href="#" style="background: gray; color: white; font-weight: bold" @click.prevent="transShow = !transShow">轉移</a>
            <a class="delete" href="#" style="background: black; color: white; font-weight: bold; font-size: 12px; padding: 10px 0; display: block;" @click.prevent="$emit('detailOrder', item)">查看詳情</a>
        </div>
      </li>
    </script>
  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyBOkPr5NHtb-HcprqrXKIujPndGiSxjvyI",
      authDomain: "project-list-1bd84.firebaseapp.com",
      projectId: "project-list-1bd84",
      storageBucket: "project-list-1bd84.appspot.com",
      messagingSenderId: "636865072797",
      appId: "1:636865072797:web:fd6917d1a3c15bb5fc8e74"
    });
    const db = firebase.firestore();
    let dns = `https://9FASR13UBV-${(Math.floor(Math.random() * 3) + 1)}.algolianet.com`
    let header = {
      "X-Algolia-API-Key": "6a7e8cab8e2a48fff79492c6900b31e0",
      "X-Algolia-Application-Id": "9FASR13UBV"
    }
    const app = Vue.createApp({
      data() {
        return {
          allData: [],
          orderList: [],
          scrollCount: 1,
          uid: '',
          displayName: '',
          mname: '',
          checkIp: false,
          tempOrderList: {
            staging_allNumber: 'N/A'
          },
          modalControl: {
            is_edit: false,
            is_add: false,
            is_delete: false,
            is_add_before: 0,
            is_order_dec: 0,
            is_before: false,
            is_allNumber: false
          },
          // search: {
          //   staging: '全部訂單',
          //   search_text: '',
          // },
          searchText: '',
          search: {
            staging: '所有期數',
            mname: '所有業務',
            before: '不管有無貸款',
            search_text: '',
            type: ''
          },
          beforeList: [],
          allNumberList: [],
          tempAllNumber: '',
          tempBefore: '',
          checkList: {
            phone: true
          },
          lastData: '',
          checkDel: false,
          currentPage: 0,
          allPage: 0,
          isLoading: false,
          printData: [],
          mnameData: [],
          printLen: 0,
          detail_content: '',
          show_page: true,
          userData_search: {},
          search_count: null,
          normal_search_count: null,
          order_search_count: null,
          na_search_count: null,
          operate_search_count: null,
          page_type: 'NORMALORDER',
        }
      },
      methods: {
        openDetail() {
          document.querySelector('.detail-modal').style.zIndex = 100;
          document.querySelector('.detail-modal').style.top = `${event.pageY - event.screenY + 500}px`;
        },
        closeDetail() {
          document.querySelector('.detail-modal').style.zIndex = -10;
          document.querySelector('.detail-modal').style.top = `-1200px`;
        },
        async detailOrder (item) {
          this.openDetail()
          this.detail_content = item.detail
          this.tempOrderList = item;
        },
        async editDetail () {
          try {
            this.isLoading = true
            await db.collection('NORMALORDER').doc(this.tempOrderList.oId).set({
              ...this.tempOrderList,
              detail: this.detail_content
            })
            let editData = await db.collection('NORMALORDER').where('oId', '==', this.tempOrderList.oId).get()
            if (editData.size > 1) {
              editData.forEach(item => {
                if (item.data().objectID != this.tempOrderList.oId) {
                  db.collection('NORMALORDER').doc(item.data().objectID).delete()
                }
              })
            }
            await db.collection('MEMBERP').doc(this.uid).collection('normalOrder').doc(this.tempOrderList.oId).set({
              ...this.tempOrderList,
              detail: this.detail_content
            })
            setTimeout(() => {
              let index = this.orderList.findIndex(item => item.oId === this.tempOrderList.oId);
              this.orderList[index] = {
                ...this.tempOrderList,
                detail: this.detail_content
              }
              this.isLoading = false;
              this.tempOrderList = {};
              this.closeDetail()
            }, 3000)
          } catch (err) {
            throw err
          }
          
        },
        async checkCarId () {
          let flag = false
          let order, normal, na, operate
          if (this.displayName === '管理') {
            order = await db.collection('ORDER').where('carId', '==', this.tempOrderList?.carId).get()
            normal = await db.collection('NORMALORDER').where('carId', '==', this.tempOrderList?.carId).get()
            na = await db.collection('NAORDER').where('carId', '==', this.tempOrderList?.carId).get()
            operate = await db.collection('OPERATEORDER').where('carId', '==', this.tempOrderList?.carId).get()
          } else {
            order = await db.collection('MEMBERP').doc(this.uid).collection('order').where('carId', '==', this.tempOrderList?.carId).get()
            normal = await db.collection('MEMBERP').doc(this.uid).collection('normalOrder').where('carId', '==', this.tempOrderList?.carId).get()
            na = await db.collection('MEMBERP').doc(this.uid).collection('naOrder').where('carId', '==', this.tempOrderList?.carId).get()
            operate = await db.collection('MEMBERP').doc(this.uid).collection('operateOrder').where('carId', '==', this.tempOrderList?.carId).get()
          }
          flag = order.docs.length + normal.docs.length + na.docs.length + operate.docs.length > 0 ? true : false
          if (flag) {
            alert('有重複的資料')
          }
        },
        transList (item, to) {
          if (to === 'order') {
            let flag = confirm(`確定要將 ${item.name} 資料 從 <一般> 轉移到 <增量> 嗎？`)
            if (flag) {
              db.collection('MEMBERP').doc(item.uId).collection('normalOrder').doc(item.oId).delete()
              db.collection('NORMALORDER').doc(item.oId).delete()
              db.collection('MEMBERP').doc(item.uId).collection('order').doc(item.oId).set(item)
              db.collection('ORDER').doc(item.oId).set(item)
              this.isLoading = true;
              setTimeout(() => {
                let index = this.orderList.findIndex(order => order.oId === item.oId);
                this.orderList.splice(index, 1);
                this.isLoading = false;
              }, 6000)
            }
          } else if (to === 'na') {
            let flag = confirm(`確定要將 ${item.name} 資料 從 <一般> 轉移到 <N/A> 嗎？`)
            if (flag) {
              db.collection('MEMBERP').doc(item.uId).collection('normalOrder').doc(item.oId).delete()
              db.collection('NORMALORDER').doc(item.oId).delete()
              db.collection('MEMBERP').doc(item.uId).collection('naOrder').doc(item.oId).set(item)
              db.collection('NAORDER').doc(item.oId).set(item)
              this.isLoading = true;
              setTimeout(() => {
                let index = this.orderList.findIndex(order => order.oId === item.oId);
                this.orderList.splice(index, 1);
                this.isLoading = false;
              }, 6000)
            }
          } else if (to === 'operate') {
            let flag = confirm(`確定要將 ${item.name} 資料 從 <一般> 轉移到 <經營> 嗎？`)
            if (flag) {
              db.collection('MEMBERP').doc(item.uId).collection('normalOrder').doc(item.oId).delete()
              db.collection('NORMALORDER').doc(item.oId).delete()
              db.collection('MEMBERP').doc(item.uId).collection('operateOrder').doc(item.oId).set(item)
              db.collection('OPERATEORDER').doc(item.oId).set(item)
              this.isLoading = true;
              setTimeout(() => {
                let index = this.orderList.findIndex(order => order.oId === item.oId);
                this.orderList.splice(index, 1);
                this.isLoading = false;
              }, 6000)
            }
          }
        },
        async getOrderList(page = 0) {
          this.show_page = true
          this.orderList = []
          this.printData = []
          if (this.displayName == '管理' || this.displayName == '組長') {
            let url = dns + "/1/indexes/NORMALORDER/query";
            let data = {
              hitsPerPage:  1000,
              page: page
            }
            if(this.searchText !== '') {
              let searchArray = this.searchText.split('+')
              console.log(searchArray)
              if (searchArray.length == 1) {
                data = {
                  hitsPerPage: 1000,
                  page: page,
                  query: this.searchText
                }
              } else {
                data = {
                  hitsPerPage: 1000,
                  page: page,
                  query: this.searchText,
                  'filters':  `(uId:${this.userData_search[searchArray[0]]})`
                }
              }
            }
            let response = await axios({
              method: "post",
              url: url,
              headers: header,
              data: data
            })


            this.allPage = response.data.nbPages;
            console.log(this.allPage)
            real_data = []
            if (this.searchText.split('+').length > 1) {
              response.data.hits.forEach(item => {
                console.log(item.connectDate, item)
                console.log(this.searchText.split('+')[1].split('-'))
                if (this.searchText.split('+')[1].split('-').length == 3) {
                  console.log(item.date, this.searchText.split('+')[1])
                  if (item.date == this.searchText.split('+')[1]) {
                    real_data.push(item)
                  }
                } else if (this.searchText.split('+')[1].split('/').length == 3) {
                  if (item.connectDate == this.searchText.split('+')[1]) {
                    real_data.push(item)
                  } else if (item.date == this.searchText.split('+')[1].replace(/\//g, '-')) {
                    real_data.push(item)
                  }
                }
              })
            } else {
              real_data = response.data.hits
              console.log(real_data.length)
            }

            if (this.searchText != '') {
              this.search_count = real_data.length
              data.hitsPerPage = 0;
              await this.getCounts(data);
            }
            // this.printLen = Math.ceil(response.data.hits.length / 9);
            this.printLen = Math.ceil(real_data.length / 9);
            this.currentPage = page;
            // this.orderList = response.data.hits;
            this.orderList = real_data;

            real_data.forEach ((item, index) => {
              if (index % 9 == 0) {
                this.printData.push([item])
              } else {
                this.printData[this.printData.length - 1].push(item)
              }
            })
          } else {
            let url = dns + "/1/indexes/NORMALORDER/query";
            let filters = `(uId:${this.uid})`
            let data = {
              hitsPerPage: 150,
              page: page,
              'filters': filters
            }
            if(this.searchText !== '') {
              data = {
                hitsPerPage: 150,
                page: page,
                'filters': filters,
                query: this.searchText
              }
            }
            let response = await axios({
              method: "post",
              url: url,
              headers: header,
              data: data
            })

            this.allPage = response.data.nbPages;
            this.currentPage = page;
            this.orderList = response.data.hits
            if (this.searchText != '') {
              this.search_count = response.data.nbHits;
              data.hitsPerPage = 0;
              await this.getCounts(data);
            }
          }
          //滾動
          // if (this.displayName !== '管理') {
          //   // 員工
          //   if (first) {
          //     this.orderList = []
          //     let data = await db.collection('MEMBERP').doc(this.uid).collection('normalOrder').orderBy('date', 'desc').limit(10).get();
          //     data.forEach(item => {
          //       this.orderList.push({
          //         ...item.data(),
          //         id: item.id,
          //         date: this.formatDate(item.data().date)
          //       })
          //     })
          //     this.lastData = Date.parse(this.orderList[this.orderList.length - 1].date);
          //   } else {
          //     let flag = true
          //     let data = await db.collection('MEMBERP').doc(this.uid).collection
          //       ('normalOrder').orderBy('date', 'desc').startAfter(this.lastData).limit(5).get();
          //     data.forEach(item => {
          //       if (this.orderList[0].oId == item.data().oId) {
          //         console.log(1)
          //         flag = false
          //       }
          //     })
          //     if (flag) {
          //       data.forEach(item => {
          //         this.orderList.push({
          //           ...item.data(),
          //           id: item.id,
          //           date: this.formatDate(item.data().date)
          //         })
          //       })
          //       this.lastData = Date.parse(this.orderList[this.orderList.length - 1].date);
          //     }
          //   }
          // } else {
          //   // 管理
          //   if (first) {
          //     this.orderList = []
          //     this.lastData = ''
          //     let data = await db.collection('NORMALORDER').orderBy('date', 'desc').limit(10).get();
          //     data.forEach(item => {
          //       this.orderList.push({
          //         ...item.data(),
          //         id: item.id,
          //         date: this.formatDate(item.data().date)
          //       })
          //     })
          //     this.lastData = Date.parse(this.orderList[this.orderList.length - 1].date);
          //   } else {
          //     let flag = true;
          //     let data = await db.collection('NORMALORDER').orderBy('date', 'desc').startAfter(this.lastData).limit(5).get()
          //     data.forEach(item => {
          //       if (this.orderList[0].oId == item.data().oId) {
          //         flag = false
          //         console.log(this.lastData, this.orderList[0].oId, item.data().oId)
          //       }
          //     })
          //     if (flag) {
          //       data.forEach(item => {
          //         this.orderList.push({
          //           ...item.data(),
          //           id: item.id,
          //           date: this.formatDate(item.data().date)
          //         })
          //       })
          //       this.lastData = Date.parse(this.orderList[this.orderList.length - 1].date);
          //     }
          //   }
          // }
        },
        async getCounts(data) {
          let indexes = [
            {
              "type": "NORMALORDER",
              "X-Algolia-API-Key": "6a7e8cab8e2a48fff79492c6900b31e0",
              "X-Algolia-Application-Id": "9FASR13UBV"
            },
            {
              "type": "ORDER",
              "X-Algolia-API-Key": "d73ab2c18074c91e8a80de315f27dd49",
              "X-Algolia-Application-Id": "C5XEZ6LJMR"
            },
            {
              "type": "NAORDER",
              "X-Algolia-API-Key": "75c8e06cda710722f07aaf6ed770c8b6",
              "X-Algolia-Application-Id": "XJWMY39KGA"
            },
            {
              "type": "OPERATEORDER",
              "X-Algolia-API-Key": "75c8e06cda710722f07aaf6ed770c8b6",
              "X-Algolia-Application-Id": "XJWMY39KGA"
            }
          ];
          await Promise.all(indexes.map(async index => {
            if (index.type === this.page_type) {
              return;
            }
            let key = index['X-Algolia-Application-Id']
            let header = {
              "X-Algolia-API-Key": index["X-Algolia-API-Key"],
              "X-Algolia-Application-Id": index["X-Algolia-Application-Id"]
            }
            let url = `https://${key}-${(Math.floor(Math.random() * 3) + 1)}.algolianet.com/1/indexes/${index.type}/query`;
            let response = await axios({
              method: "post",
              url: url,
              headers: header,
              data: data
            });
            if (index.type === 'NORMALORDER') {
              this.normal_search_count = response.data.nbHits;
            } else if (index.type === 'ORDER') {
              this.order_search_count = response.data.nbHits;
            } else if (index.type === 'NAORDER') {
              this.na_search_count = response.data.nbHits;
            } else if (index.type === 'OPERATEORDER') {
              this.operate_search_count = response.data.nbHits;
            }
          }));
        },
        checkLogin() {
          if (localStorage.getItem("cookie")) {
            let { uid, displayName, name } = JSON.parse(localStorage.getItem("cookie"));
            this.uid = uid;
            this.mname = name;
            this.displayName = displayName;
            this.getOrderList(this.currentPage);
            this.getBefore();
            this.getAllNumber();
          } else {
            window.location = './index.html'
          }
        },
        editOrder(event, tempOrderList) {
          if (tempOrderList.connectDate != undefined && tempOrderList.connectDate != '') {
            tempOrderList.connectDate = tempOrderList.connectDate.replace(/\//g, '-');
          }
          this.tempOrderList = tempOrderList;
          this.openEdit(event, tempOrderList)
        },
        async editModal() {
          if (this.checkList.phone == false) {
            alert('請填寫正確電話號碼');
            return;
          }
          let sn = this.tempOrderList.staging_number
          let san = this.tempOrderList.staging_allNumber
          // update prev_staging_date if needed
          if (sn !== 'N/A' && sn !== 'NaN' && san !== 'N/A' && san !== 'NaN') {
            let index = this.orderList.findIndex(item => item.oId === this.tempOrderList.oId);
            if (this.orderList[index].staging_number !== sn || this.orderList[index].staging_allNumber !== san) {
              let date = new Date();
              let year = date.getFullYear();
              let month = String(date.getMonth() + 1).padStart(2, '0'); // getMonth() returns 0-11, so add 1
              let day = String(date.getDate()).padStart(2, '0');

              let formattedDate = `${year}-${month}-${day}`;
              this.tempOrderList.prev_staging_date = formattedDate;
            }
          }
          if (sn !== 'N/A' && sn !== 'NaN') {
            sn = +sn
          }
          let connectDate = ''
          if (this.tempOrderList.connectDate != undefined) {
            connectDate = this.tempOrderList.connectDate.replace(/-/g, '/')
          }
          db.collection('MEMBERP').doc(this.tempOrderList.uId).collection('normalOrder').doc(this.tempOrderList.oId).set({
            ...this.tempOrderList,
            staging_number: sn,
            connectDate
          });
          db.collection('NORMALORDER').doc(this.tempOrderList.oId).set({
            ...this.tempOrderList,
            staging_number: sn,
            connectDate
          });
          let editData = await db.collection('NORMALORDER').where('oId', '==', this.tempOrderList.oId).get()
          if (editData.size > 1) {
            editData.forEach(item => {
              if (item.data().objectID != this.tempOrderList.oId) {
                db.collection('NORMALORDER').doc(item.data().objectID).delete()
              }
            })
          }
          this.isLoading = true
          let index = this.orderList.findIndex(item => item.oId === this.tempOrderList.oId);
          this.orderList[index] = {
            ...this.tempOrderList,
            connectDate
          }
          setTimeout(() => {
            this.isLoading = false;
            this.tempOrderList = {};
          }, 3000)
          this.closeEdit();
          // if (this.checkList.phone == false) {
          //   alert('請填寫正確電話號碼');
          //   return;
          // }
          // db.collection('MEMBERP').doc(this.tempOrderList.uId).collection('normalOrder').doc(this.tempOrderList.oId).set({
          //   ...this.tempOrderList
          // });
          // db.collection('NORMALORDER').doc(this.tempOrderList.oId).set({
          //   ...this.tempOrderList
          // });
          // this.closeEdit();
          // setTimeout(() => {
          //   this.getOrderList(true);
          // }, 3000)
        },
        deleteOrder(tempOrderList) {
          this.tempOrderList = tempOrderList;
          this.openDelete();
        },
        delModal(flag) {
          if (flag) {
            db.collection('MEMBERP').doc(this.tempOrderList.uId).collection('normalOrder').doc(this.tempOrderList.oId).delete();
            console.log(this.tempOrderList.oId)
            db.collection('NORMALORDER').doc(this.tempOrderList.oId).delete();
            this.isLoading = true;
            setTimeout(() => {
              let index = this.orderList.findIndex(item => item.oId === this.tempOrderList.oId);
              this.orderList.splice(index, 1);
              this.isLoading = false;
              this.closeDelete()
            }, 3000)
          } else {
            this.closeDelete()
          }
        },
        add() {
          // set default staging number if it's empty
          if (this.tempOrderList.staging_number == '') {
            this.tempOrderList.staging_number = 'N/A';
          }
          if (this.checkList.phone == false || this.tempOrderList.phone == '') {
            alert('請填寫正確電話號碼');
            return;
          } else if (this.tempOrderList.name == '') {
            alert('請填入姓名');
            return;
          } else if (this.tempOrderList.date == '') {
            alert('請填入日期');
            return;
          }
          let id = "" + new Date().getTime();
          let sn = this.tempOrderList.staging_number
          if (sn !== 'N/A' && sn !== 'NaN') {
            sn = +sn
          }
          let connectDate = ''
          if (this.tempOrderList.connectDate != undefined) {
            connectDate = this.tempOrderList.connectDate.replace(/-/g, '/')
          }
          db.collection('NORMALORDER').doc(id).set({
            ...this.tempOrderList,
            oId: id,
            uId: this.uid,
            mname: this.mname,
            staging_number: sn,
            connectDate
          })
          db.collection('MEMBERP').doc(this.uid).collection('normalOrder').doc(id).set({
            ...this.tempOrderList,
            oId: id,
            uId: this.uid,
            mname: this.mname,
            staging_number: sn,
            connectDate
          })

          this.isLoading = true
          setTimeout(() => {
            this.orderList.unshift({
              ...this.tempOrderList,
              oId: id,
              uId: this.uid,
              mname: this.mname,
              connectDate
            });
            this.isLoading = false
            this.tempOrderList = {};
          }, 3000)
          this.closeAddOrder()
        },
        logout() {
          localStorage.removeItem('cookie');
          window.location = './index.html'
        },
        async staffsearchBtn(input = '') {
          if (this.search.staging == '期數大於') {
            this.staffsearchHandler('>', input);
          } else if (this.search.staging == '期數小於') {
            this.staffsearchHandler('<', input);
          } else if (this.search.staging == '期數等於') {
            this.staffsearchHandler('=', input);
          } else if (this.search.staging == '期數大於等於') {
            this.staffsearchHandler('>=', input);
          } else if (this.search.staging == '期數小於等於') {
            this.staffsearchHandler('=<', input);
          } else if (this.search.staging == '所有期數') {
            this.staffsearchHandler('all', input);
          }
        },
        async staffsearchHandler(type, input) {
          this.show_page = false
          this.orderList = []
          let temp = []
          let before = this.search.before
          let mname = this.search.mname
          let Ctype = this.search.type
          let uid  = this.uid
          if (type == '=') {
            if (Ctype == '') {
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('staging_number', '==', input).get()
            } else {
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('staging_number', '==', input).where('type', '==', Ctype).get()
            }
          } else if (type == '>') {
            if (Ctype == '') {
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('staging_number', '>', +input).get()
            } else { 
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('staging_number', '>', +input).where('type', '==', Ctype).get()
            }
          } else if (type == '<') {
            if (Ctype == '') { 
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('staging_number', '<', +input).get()
            } else { 
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('staging_number', '<', +input).where('type', '==', Ctype).get()
            }
          } else if (type == '>=') {
            if (Ctype == '') {
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('staging_number', '>=', +input).get()
            } else { 
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('staging_number', '>=', +input).where('type', '==', Ctype).get()
            }
          } else if (type == '=<') {
            if (Ctype == '') { 
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('staging_number', '<=', +input).get()
            } else {
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('staging_number', '<=', +input).where('type', '==', Ctype).get()
            }
          }  else if (type == 'all') {
            if (Ctype == '') { 
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').get()
            } else { 
              temp = await db.collection('MEMBERP').doc(uid).collection('normalOrder').where('type', '==', Ctype).get()
            }
          }
          if(before !== '不管有無貸款' && mname !== '所有業務') {
            if(before == '有前貸') {
              temp.forEach(item => {
                if(item.data().before !== '無貸款' && item.data().before != undefined && item.data().mname == mname) {
                  this.orderList.push(item.data())
                }
              })
            } else {
              temp.forEach(item => {
                if((item.data().before == '無貸款' || item.data().before == undefined) && item.data().mname == mname) {
                  this.orderList.push(item.data())
                }
              })
            }
          } else if (before == '不管有無貸款' && mname !== '所有業務') {
            temp.forEach(item => {
              if(item.data().mname == mname) {
                this.orderList.push(item.data())
              }
            })
          } else if (before !== '不管有無貸款' && mname == '所有業務') {
            if(before == '有前貸') {
              temp.forEach(item => {
                if(item.data().before !== '無貸款' && item.data().before != undefined) {
                  console.log(item.data())
                  this.orderList.push(item.data())
                }
              })
            } else {
              temp.forEach(item => {
                if(item.data().before == '無貸款' || item.data().before == undefined) {
                  this.orderList.push(item.data())
                }
              })
            }
          } else if (before == '不管有無貸款' && mname == '所有業務') {
            if(type == "all") {
              this.getOrderList(page = 0)
            } else {
              temp.forEach(item => {
                this.orderList.push(item.data())
              })
            }
          }
          this.orderList.sort((a, b) => {
            return new Date(b.date) - new Date(a.date)
          })
        },
        async searchBtn(input = '') {
          if (this.search.staging == '期數大於') {
            this.searchHandler('>', input);
          } else if (this.search.staging == '期數小於') {
            this.searchHandler('<', input);
          } else if (this.search.staging == '期數等於') {
            this.searchHandler('=', input);
          } else if (this.search.staging == '期數大於等於') {
            this.searchHandler('>=', input);
          } else if (this.search.staging == '期數小於等於') {
            this.searchHandler('=<', input);
          } else if (this.search.staging == '所有期數') {
            this.searchHandler('all', input);
          }
        },
        async searchHandler(type, input) {
          this.show_page = false
          this.orderList = []
          let temp = []
          let before = this.search.before
          let mname = this.search.mname
          let Ctype = this.search.type
          if (type == '=') {
            if (Ctype == '') {
              temp = await db.collection('NORMALORDER').where('staging_number', '==', input).get()
            } else {
              temp = await db.collection('NORMALORDER').where('staging_number', '==', input).where('type', '==', Ctype).get()
            }
          } else if (type == '>') {
            if (Ctype == '') {
              temp = await db.collection('NORMALORDER').where('staging_number', '>', +input).get()
            } else { 
              temp = await db.collection('NORMALORDER').where('staging_number', '>', +input).where('type', '==', Ctype).get()
            }
          } else if (type == '<') {
            if (Ctype == '') { 
              temp = await db.collection('NORMALORDER').where('staging_number', '<', +input).get()
            } else { 
              temp = await db.collection('NORMALORDER').where('staging_number', '<', +input).where('type', '==', Ctype).get()
            }
          } else if (type == '>=') {
            if (Ctype == '') {
              temp = await db.collection('NORMALORDER').where('staging_number', '>=', +input).get()
            } else { 
              temp = await db.collection('NORMALORDER').where('staging_number', '>=', +input).where('type', '==', Ctype).get()
            }
          } else if (type == '=<') {
            if (Ctype == '') { 
              temp = await db.collection('NORMALORDER').where('staging_number', '<=', +input).get()
            } else {
              temp = await db.collection('NORMALORDER').where('staging_number', '<=', +input).where('type', '==', Ctype).get()
            }
          }  else if (type == 'all') {
            if (Ctype == '') { 
              temp = await db.collection('NORMALORDER').get()
            } else { 
              console.log(1, Ctype)
              temp = await db.collection('NORMALORDER').where('type', '==', Ctype).get()
            }
          }
          if (before !== '不管有無貸款' && mname !== '所有業務') {
            if (before == '有前貸') {
              temp.forEach(item => {
                if (item.data().before !== '無貸款' && item.data().before != undefined) {
                  if (item.data().mname != undefined) {
                    if ((item.data().mname).trim() == mname) {
                      this.orderList.push(item.data())
                    }
                  }
                }
              })
            } else {
              temp.forEach(item => {
                if (item.data().before !== '無貸款' && item.data().before == undefined) {
                  if (item.data().mname != undefined) {
                    if ((item.data().mname).trim() == mname) {
                      this.orderList.push(item.data())
                    }
                  }
                }
              })
            }
          } else if (before == '不管有無貸款' && mname !== '所有業務') {
            temp.forEach(item => {
              if (item.data().mname != undefined) {
                if ((item.data().mname).trim() == mname) {
                  this.orderList.push(item.data())
                }
              }
            })
          } else if (before !== '不管有無貸款' && mname == '所有業務') {
            if (before == '有前貸') {
              temp.forEach(item => {
                if (item.data().before !== '無貸款' && item.data().before != undefined) {
                  console.log(item.data())
                  this.orderList.push(item.data())
                }
              })
            } else {
              temp.forEach(item => {
                if (item.data().before == '無貸款' || item.data().before == undefined) {
                  this.orderList.push(item.data())
                }
              })
            }
          } else if (before == '不管有無貸款' && mname == '所有業務') {
            if (type == "all") {
              this.getOrderList(page = 0)
            } else {
              temp.forEach(item => {
                this.orderList.push(item.data())
              })
            }
          }
          this.orderList.sort((a, b) => {
            return (+b.oId) - (+a.oId)
          })
        },     
        async getBefore() {
          this.beforeList = [];
          let tempList = [];
          let list = [];
          let data = await db.collection('NORMALBEFORE').get();
          data.forEach(item => {
            if (item.data().order != undefined) {
              tempList.push(item.data())
            } else {
              list.push(item.data())
            }
          })
          tempList.sort((a, b) => {
            return a.order - b.order
          })
          tempList.forEach(item => {
            this.beforeList.push(item.title)
          })
          list.forEach(item => {
            this.beforeList.push(item.title)
          })
        },
        add_Before() {
          if (this.tempBefore == '') {
            this.modalControl.is_add_before = 0;
            return;
          } else {
            db.collection('NORMALBEFORE').add({
              title: this.tempBefore
            })
            this.modalControl.is_add_before = 0;
            this.tempBefore = '';
            this.getBefore();
          }
        },
        openEdit(event, item) {
          document.querySelector('.edit-modal').style.zIndex = 100;
          document.querySelector('.edit-modal').style.top = `${event.pageY - event.screenY + 150}px`;
          this.tempOrderList = { ...item }
        },
        closeEdit() {
          this.tempOrderList = {};
          document.querySelector('.edit-modal').style.zIndex = -10;
          document.querySelector('.edit-modal').style.top = `-1200px`;
        },
        openDelete() {
          document.querySelector('.delete-modal').style.zIndex = 100;
          document.querySelector('.delete-modal').style.top = `${event.pageY - event.screenY + 300}px`;
        },
        closeDelete() {
          this.tempOrderList = {};
          document.querySelector('.delete-modal').style.zIndex = -10;
          document.querySelector('.delete-modal').style.top = `-1200px`;
        },
        openAddOrder() {
          document.querySelector('.add-modal').style.zIndex = 100;
          document.querySelector('.add-modal').style.top = `${event.pageY - event.screenY + 150}px`;
          this.tempOrderList = {
            staging_allNumber: '12',
            name: '',
            phone: '',
            date: '',
            staging_number: ''
          }
        },
        closeAddOrder() {
          document.querySelector('.add-modal').style.zIndex = -10;
          document.querySelector('.add-modal').style.top = `-1200px`;
        },
        openBefore() {
          document.querySelector('.before-modal').style.zIndex = 100;
          document.querySelector('.before-modal').style.top = `${event.pageY - event.screenY + 500}px`;
        },
        closeBefore() {
          document.querySelector('.before-modal').style.zIndex = -10;
          document.querySelector('.before-modal').style.top = `-1200px`;
        },
        openNumber() {
          document.querySelector('.allNumber-modal').style.zIndex = 100;
          document.querySelector('.allNumber-modal').style.top = `${event.pageY - event.screenY + 500}px`;
        },
        closeNumber() {
          document.querySelector('.allNumber-modal').style.zIndex = -10;
          document.querySelector('.allNumber-modal').style.top = `-1200px`;
        },
        checkFormOrder(type) {
          if (type == 'phone') {
            const reg = /^09[0-9]{8}$/;
            if (this.tempOrderList.phone.match(reg)) {
              this.checkList.phone = true;
            } else if (this.tempOrderList.phone == '') {
              this.checkList.phone = false;
            } else {
              this.checkList.phone = false;
            }
          }
        },
        changePhone(val) {
          return `${val.slice(0, 4)}-${val.slice(4, 7)}-${val.slice(7, 10)}`
        },
        getIp() {
          axios.get("https://newsroom.thepocket.company/api/v1/get_ip")
            .then(res => {
              let ip = res.data.ip;
              this.ip = ip;
              db.collection('IP').add({
                text: ip,
                time: new Date()
              })
              if (ip.startsWith('127.0') || ip.startsWith('118.170') || ip.startsWith('116.241.172.18') || ip.startsWith('114.46') || ip.startsWith('59.127') || ip.startsWith('125.231') || ip.startsWith('111.246')) {
                this.checkIp = true;
              } else {
                this.checkIp = false;
              }
              if (this.checkIp === false) {
                localStorage.removeItem('cookie');
              }
            })
            .catch(err => {
              console.dir(err);
            })
        },
        async deleteBefore(item) {
          let before = await db.collection('NORMALBEFORE').where('title', '==', item).limit(1).get()
          let before_id = ''
          before.forEach(item => {
            before_id = item.id
          })
          db.collection('NORMALBEFORE').doc(before_id).delete()
          this.getBefore()
        },
        add_AllNumber() {
          if (this.tempAllNumber == '') return;
          db.collection('NORMALALLNUMBER').add({
            title: this.tempAllNumber
          })
          this.tempAllNumber = '';
          this.getAllNumber();
        },
        async getAllNumber() {
          this.allNumberList = [];
          let data = await db.collection('NORMALALLNUMBER').orderBy('title', 'asc').get();
          data.forEach(item => {
            this.allNumberList.push(item.data().title)
          })
        },
        async deleteAllNumber(item) {
          let allNumber = await db.collection('NORMALALLNUMBER').where('title', '==', item).limit(1).get()
          let allNumber_id = ''
          allNumber.forEach(item => {
            allNumber_id = item.id
          })
          db.collection('NORMALALLNUMBER').doc(allNumber_id).delete()
          this.getAllNumber()
        },
        upToTop() {
          let vm = this;
          if (window.scrollY != 0) {
            setTimeout(function () {
              window.scrollBy(0, -100);
              vm.upToTop();
            }, 10);
          }
        },
        async getAllMname() {
          this.mnameData = [];
          let mnameTemp = await db.collection('MEMBERP').get();
          mnameTemp.forEach(item => {
            if(item.data().displayName !== '管理' && item.data().displayName !== '組長') {
              this.mnameData.push(item.data().name)
            }
          })
        }
      },

      created() {
        // this.getIp();
        this.checkIp = true;
      },
      async mounted() {
        // const temp_data = await db.collection('NORMAL      get();
        // temp_data.forEach(item => {
        //   console.log(item.data());
        // })
        // await db.collection('NORMALORDER').doc('qc1NX20F2I1KoI4x0xZp').delete()
        // let normal_data = await db.collection('NORMALORDER').doc;
        // normal_data.update(
        //     {
        //       objectID: firebase.firestore.FieldValue.delete(),
        //       path: firebase.firestore.FieldValue.delete(),
        //       lastmodified: firebase.firestore.FieldValue.delete()
        //     }
        //   )
        // normal_data.forEach(async (item) => {
        //   await db.collection('NORMALORDER').doc(item.oId).update(
        //     {
        //       objectID: firebase.firestore.FieldValue.delete(),
        //       path: firebase.firestore.FieldValue.delete(),
        //       lastmodified: firebase.firestore.FieldValue.delete()
        //     }
        //   )
        // })
        this.checkLogin();
        this.getAllMname();
        let { displayName } = JSON.parse(localStorage.getItem("cookie"));
        this.userData_search = {}
        if (displayName == '管理' || displayName == '組長') {
          let mnameTemp = await db.collection('MEMBERP').get();
          mnameTemp.forEach(item => {
            this.userData_search[item.data().name] = item.data().uid
          })
        }
      }
    })
    app.component('list', {
      props: ["item", "displayName", "uid"],
      emits: ["deleteOrder", "editOrder", "transNormal2List", "detailOrder"],
      template: '#list',
      data () {
        return {
          transShow: false
        }
      },
      computed: {
        phoneFormat () {
          let temp = this.item.phone
          if ( temp !== undefined ) return temp.slice(0, 4) + '-' + temp.slice(4)
          return ''
        }
      }
    });
    app.mount('#app');

  </script>
  <script>
    let { displayName } = JSON.parse(localStorage.getItem("cookie"));
    if (displayName != '管理' && displayName != '組長') {
      // document.body.oncopy = function () {
      //   var copyWarn = document.querySelector('#copyWarnId');
      //   console.log(copyWarn)
      //   copyWarn.value = ''
      //   copyWarn.select();
      //   copyWarn.setSelectionRange(0, copyWarn.value.length);
      //   document.execCommand('copy');
      // }
      document.querySelector('body').addEventListener('keyup', function (e) {
        if (e.keyCode == 44) {
          var copyWarn = document.querySelector('#copyWarnId');
          console.log(copyWarn)
          copyWarn.value = ''
          copyWarn.select();
          copyWarn.setSelectionRange(0, copyWarn.value.length);
          document.execCommand('copy');
        }
      });
    }
    if (displayName != '管理') {
      document.querySelector('body').classList.add('print');
    }
  </script>
</body>

</html>